# Upload Wizard & Data Transformation: A Technical Guide

This document provides a detailed technical breakdown of the CSV import process, covering the frontend React component, the backend Node.js server, and the AI-powered data transformation logic.

## 1. Core Principles

- **Dual-Path Processing:** The system supports two distinct workflows: a direct AI transformation for smaller files and a more robust, two-step "config generation" process for large files to handle performance and memory constraints.
- **State-Driven UI:** The entire wizard is a single React component (`CsvImportWizard.tsx`) that relies on state variables (`aiStep`, `step`, etc.) to render the correct UI for each stage of the import process.
- **Backend-Powered Transformation:** All heavy lifting (CSV parsing, AI calls, data pivoting) is delegated to a Node.js/Express backend (`backend-server-example.cjs`) to keep the frontend responsive.
- **Data Integrity:** The backend is responsible for ensuring data integrity, especially during pivoting. This includes preserving data sparsity (not filling in missing date gaps) and correctly sorting date-based columns chronologically.
- **Explicit Column Order:** The backend explicitly sends a sorted `columns` array to the frontend. The frontend **must** use this array to render table headers, as the key order in JavaScript objects is not guaranteed.

---

## 2. Frontend Component: `CsvImportWizard.tsx`

This is the main component orchestrating the entire user experience.

### A. Key State Variables

- `file`, `originalCsv`: Holds the raw uploaded file and its string content.
- `aiStep`: Manages the sub-steps within the AI-powered workflow (e.g., `'upload'`, `'describe'`, `'ai-preview'`).
- `step`: Manages the top-level wizard steps (e.g., `'upload'`, `'preview'`, `'mapping'`).
- `aiLoading`, `configLoading`: Boolean flags to indicate when an AI or large-file configuration process is running, used to show loading spinners.
- `aiResult`: Stores the transformed data returned from the backend, typically as a 2D array (`string[][]`).
- `aiResultColumns`: **Crucially**, this stores the explicitly sorted list of column headers returned from the backend. This is the source of truth for rendering table headers.
- `generatedConfig`: Stores the JSON configuration object generated by the AI for large file processing.

### B. User Workflow & Function Handlers

1.  **File Upload (`handleFileChange`)**:
    - The user selects a file.
    - The file is read as text and stored in `originalCsv`.
    - The file size is checked against `largeFileThreshold`.
    - The UI transitions to the method selection screen (`aiStep: 'describe'`).

2.  **Method Selection (AI vs. Manual)**:
    - The user chooses between "Use AI" or "Manual Import".
    - **"Use AI"** triggers either `handleAITransform` (small files) or `handleConfigProcessing` (large files).

3.  **AI Transformation**:
    - **`handleAITransform` (Small Files)**:
        - Makes a single `POST` request to `/api/grok-transform`.
        - The request body contains the entire `originalCsv` content.
        - The API response contains `transformedData` and the sorted `columns` array.
        - The handler updates `aiResult` and `aiResultColumns` states.
    - **`handleConfigProcessing` (Large Files)**:
        - **Step 1: Generate Config**: Makes a `POST` request to `/api/grok-generate-config` with a *sample* of the CSV. The backend returns a JSON configuration object.
        - **Step 2: Apply Config**: Makes a second `POST` request to `/api/apply-config` with the `originalCsv` and the `config` from the previous step.
        - The API response contains the final `transformedData` and the sorted `columns` array.
        - The handler updates `aiResult` and `aiResultColumns` states.

4.  **AI Transformed Preview**:
    - This view is rendered when `aiResult` is populated.
    - The table headers are rendered by mapping over the `aiResultColumns` state array, ensuring correct order.
    - The table body is rendered from the `aiResult` data, limited to `PREVIEW_ROW_LIMIT`.

---

## 3. Backend Server: `backend-server-example.cjs`

The backend handles all data processing and communication with the Grok AI API.

### A. API Endpoints

- **`POST /api/grok-transform`**:
    - Used for the small file workflow.
    - Receives the full CSV data.
    - Directly calls the Grok API to perform the transformation in one step.
    - Returns the transformed data and extracts column headers using `Object.keys()` before sending the response.

- **`POST /api/grok-generate-config`**:
    - Used for the large file workflow (step 1).
    - Receives a small *chunk* of the CSV.
    - Asks the Grok API to analyze the sample and return a JSON object of transformation steps (e.g., rename, filter, pivot).
    - Returns the `config` object.

- **`POST /api/apply-config`**:
    - Used for the large file workflow (step 2).
    - Receives the full CSV data and the `config` object.
    - It **does not** call the AI. Instead, it iterates through the operations in the `config` object and applies them locally using the `applyTransformations` helper function.
    - This is where the critical `pivotTable` function is called.
    - Returns the `transformedData` and the explicitly sorted `columns` array generated by `pivotTable`.

### B. The `pivotTable` Function

This is the most complex and critical part of the backend transformation logic.

- **Purpose**: To transform data from a "long" format (one row per sale) to a "wide" format (one row per product, with dates as columns).
- **Sparsity**: It only creates columns for dates that **actually exist** in the dataset. It does not fill in gaps, preventing the creation of artificial zero-data points.
- **Date Normalization**: It normalizes all incoming date values to a clean `YYYY-MM-DD` format. This is crucial for consistent keying and sorting. It uses `new Date(col.split('T')[0]).toISOString().split('T')[0]` for this.
- **Chronological Sorting**: After collecting all unique, normalized date columns, it performs a proper date-based sort using a custom sort function: `(a, b) => new Date(a) - new Date(b)`. Standard string sorting would fail here.
- **Return Value**: It returns an object containing both the pivoted `data` and the sorted `columns` array.

---

## 4. Troubleshooting Checklist

If the upload or transformation fails, check the following:

1.  **Is the frontend using `aiResultColumns` to render the table headers?** This is the most common cause of sorting issues. Check the `renderContent` logic in `CsvImportWizard.tsx`.
2.  **Does the backend API response include the `columns` array?** Check the browser's network tab to inspect the JSON response from `/api/apply-config` or `/api/grok-transform`.
3.  **Are the backend logs for `pivotTable` showing correct sorting?** Check the terminal output for the `--- Pivot Table Debug ---` logs to confirm "Columns after sorting" is in chronological order.
4.  **Is there a mismatch between the keys in the data and the `columns` array?** The `pivotTable` function must use the *exact same* normalized date string for both the data object keys and the `allColumns` set. This was the source of a previous bug.
5.  **Is the correct workflow (small vs. large file) being triggered?** Check the `handleFileChange` logic and the value of `largeFileThreshold`.

---

## Summary Table

| Stage              | Component/File                 | Key Function(s)                   | Critical Logic                                      |
| ------------------ | ------------------------------ | --------------------------------- | --------------------------------------------------- |
| **File Upload**    | `CsvImportWizard.tsx`          | `handleFileChange`                | Detects file size to choose workflow.               |
| **Small File AI**  | `CsvImportWizard.tsx`          | `handleAITransform`               | Calls `/api/grok-transform`.                        |
| **Large File AI**  | `CsvImportWizard.tsx`          | `handleConfigProcessing`          | Calls `/grok-generate-config`, then `/apply-config`.|
| **Backend Pivot**  | `backend-server-example.cjs`   | `pivotTable`                      | Date normalization, chronological sort, sparsity.   |
| **Frontend Render**| `CsvImportWizard.tsx`          | `renderContent` (JSX)             | Uses `aiResultColumns` to build `<th>` headers.     |
| **API Response**   | `backend-server-example.cjs`   | `/apply-config` handler           | Returns `{ transformedData, columns }`.             | 